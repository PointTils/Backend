# Est치gio de build
FROM maven:3.8.4-openjdk-17 AS build

WORKDIR /application

# Copiar apenas os arquivos essenciais primeiro
COPY pom.xml .
COPY mvnw .
COPY .mvn .mvn

RUN chmod +x mvnw

# Copiar o restante do c칩digo
COPY src ./src

# Compilar e empacotar
RUN ./mvnw clean package -DskipTests

# Est치gio final
FROM openjdk:17-jdk-slim
WORKDIR /application

COPY --from=build /application/target/pointtils-0.0.1-SNAPSHOT.jar app.jar

# Definir vari치veis de ambiente a partir dos build args
ENV SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
ENV SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
ENV SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
ENV SPRING_APPLICATION_NAME=${SPRING_APPLICATION_NAME}
ENV SERVER_PORT=${SERVER_PORT}
ENV JWT_SECRET=${JWT_SECRET}
ENV JWT_EXPIRATION_TIME=${JWT_EXPIRATION_TIME}
ENV JWT_REFRESH_EXPIRATION_TIME=${JWT_REFRESH_EXPIRATION_TIME}
ENV SPRING_JPA_HIBERNATE_DDL_AUTO=${SPRING_JPA_HIBERNATE_DDL_AUTO}
ENV SPRING_JPA_SHOW_SQL=${SPRING_JPA_SHOW_SQL}
ENV SPRING_FLYWAY_ENABLED=${SPRING_FLYWAY_ENABLED}
ENV SPRING_FLYWAY_LOCATIONS=${SPRING_FLYWAY_LOCATIONS}
ENV SPRING_FLYWAY_BASELINE_ON_MIGRATE=${SPRING_FLYWAY_BASELINE_ON_MIGRATE}
ENV SPRING_FLYWAY_VALIDATE_ON_MIGRATE=${SPRING_FLYWAY_VALIDATE_ON_MIGRATE}
ENV SPRINGDOC_API_DOCS_ENABLED=${SPRINGDOC_API_DOCS_ENABLED}
ENV SPRINGDOC_SWAGGER_UI_ENABLED=${SPRINGDOC_SWAGGER_UI_ENABLED}
ENV SPRINGDOC_SWAGGER_UI_PATH=${SPRINGDOC_SWAGGER_UI_PATH}

EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
