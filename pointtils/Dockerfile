# Est치gio de build
FROM maven:3.8.4-openjdk-17 AS build

WORKDIR /application

# Copiar apenas os arquivos essenciais primeiro
COPY pom.xml .
COPY mvnw .
COPY .mvn .mvn

RUN chmod +x mvnw

# Copiar o restante do c칩digo
COPY src ./src

# Compilar e empacotar
RUN ./mvnw clean package -DskipTests

# Est치gio final
FROM openjdk:17-jdk-slim-bullseye
WORKDIR /application

COPY --from=build /application/target/pointtils-0.0.1-SNAPSHOT.jar app.jar

# Definir argumentos de build
ARG SPRING_DATASOURCE_URL
ARG SPRING_DATASOURCE_USERNAME
ARG SPRING_DATASOURCE_PASSWORD
ARG SPRING_APPLICATION_NAME
ARG SERVER_PORT
ARG JWT_SECRET
ARG JWT_EXPIRATION_TIME
ARG JWT_REFRESH_EXPIRATION_TIME
ARG SPRING_JPA_HIBERNATE_DDL_AUTO
ARG SPRING_JPA_SHOW_SQL
ARG SPRING_FLYWAY_ENABLED
ARG SPRING_FLYWAY_LOCATIONS
ARG SPRING_FLYWAY_BASELINE_ON_MIGRATE
ARG SPRING_FLYWAY_VALIDATE_ON_MIGRATE
ARG SPRINGDOC_API_DOCS_ENABLED
ARG SPRINGDOC_SWAGGER_UI_ENABLED
ARG SPRINGDOC_SWAGGER_UI_PATH
ARG CLOUD_AWS_BUCKET_NAME
ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY
ARG AWS_REGION
ARG BREVO_SMTP_HOST
ARG BREVO_SMTP_PORT
ARG BREVO_SMTP_USERNAME
ARG BREVO_SMTP_PASSWORD
ARG BREVO_SENDER_EMAIL
ARG BREVO_SENDER_NAME
ARG ADMIN_EMAIL

# Definir vari치veis de ambiente a partir dos build args
ENV SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
ENV SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
ENV SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
ENV SPRING_APPLICATION_NAME=${SPRING_APPLICATION_NAME}
ENV SERVER_PORT=${SERVER_PORT}
ENV JWT_SECRET=${JWT_SECRET}
ENV JWT_EXPIRATION_TIME=${JWT_EXPIRATION_TIME}
ENV JWT_REFRESH_EXPIRATION_TIME=${JWT_REFRESH_EXPIRATION_TIME}
ENV SPRING_JPA_HIBERNATE_DDL_AUTO=${SPRING_JPA_HIBERNATE_DDL_AUTO}
ENV SPRING_JPA_SHOW_SQL=${SPRING_JPA_SHOW_SQL}
ENV SPRING_FLYWAY_ENABLED=${SPRING_FLYWAY_ENABLED}
ENV SPRING_FLYWAY_LOCATIONS=${SPRING_FLYWAY_LOCATIONS}
ENV SPRING_FLYWAY_BASELINE_ON_MIGRATE=${SPRING_FLYWAY_BASELINE_ON_MIGRATE}
ENV SPRING_FLYWAY_VALIDATE_ON_MIGRATE=${SPRING_FLYWAY_VALIDATE_ON_MIGRATE}
ENV SPRINGDOC_API_DOCS_ENABLED=${SPRINGDOC_API_DOCS_ENABLED}
ENV SPRINGDOC_SWAGGER_UI_ENABLED=${SPRINGDOC_SWAGGER_UI_ENABLED}
ENV SPRINGDOC_SWAGGER_UI_PATH=${SPRINGDOC_SWAGGER_UI_PATH}
ENV CLOUD_AWS_BUCKET_NAME=${CLOUD_AWS_BUCKET_NAME}
ENV AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
ENV AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
ENV AWS_REGION=${AWS_REGION}
ENV BREVO_SMTP_HOST=${BREVO_SMTP_HOST}
ENV BREVO_SMTP_PORT=${BREVO_SMTP_PORT}
ENV BREVO_SMTP_USERNAME=${BREVO_SMTP_USERNAME}
ENV BREVO_SMTP_PASSWORD=${BREVO_SMTP_PASSWORD}
ENV BREVO_SENDER_EMAIL=${BREVO_SENDER_EMAIL}
ENV BREVO_SENDER_NAME=${BREVO_SENDER_NAME}
ENV ADMIN_EMAIL=${ADMIN_EMAIL}

EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
